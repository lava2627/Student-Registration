<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WE Trust - Admin Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      animation: fadeInUp 0.6s ease-out;
      margin-bottom: 20px;
    }

    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .login-section {
      max-width: 400px;
      margin: 100px auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      margin-bottom: 8px;
    }

    input, select {
      width: 100%;
      padding: 15px 20px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 16px;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    input:focus, select:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.4);
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      width: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin-right: 10px;
      margin-bottom: 10px;
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #51cf66, #40c057);
      color: white;
    }

    .btn:disabled {
      background: rgba(255, 255, 255, 0.1) !important;
      color: rgba(255, 255, 255, 0.5) !important;
      cursor: not-allowed;
      transform: none !important;
    }

    h1, h2, h3 {
      color: rgba(255, 255, 255, 0.95);
      font-weight: 700;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 2.5rem;
      text-align: center;
      background: linear-gradient(135deg, #fff, #f0f0f0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 40px;
    }

    .filters-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      padding: 25px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
      transform: scale(1.2);
    }

    .data-table {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: 600px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    th {
      background: rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.95);
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    td {
      color: rgba(255, 255, 255, 0.8);
    }

    tr:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 12px;
      color: white;
      font-weight: 500;
      display: none;
      z-index: 1000;
      backdrop-filter: blur(20px);
      animation: slideIn 0.3s ease-out;
      max-width: 400px;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .success {
      background: linear-gradient(135deg, rgba(40, 167, 69, 0.9), rgba(40, 167, 69, 0.7));
      border: 1px solid rgba(40, 167, 69, 0.3);
    }

    .error {
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.9), rgba(220, 53, 69, 0.7));
      border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .warning {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.9), rgba(255, 193, 7, 0.7));
      border: 1px solid rgba(255, 193, 7, 0.3);
      color: #000;
    }

    .info {
      background: linear-gradient(135deg, rgba(23, 162, 184, 0.9), rgba(23, 162, 184, 0.7));
      border: 1px solid rgba(23, 162, 184, 0.3);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .export-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .section-divider {
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      margin: 40px 0;
      border: none;
    }

    .hidden {
      display: none !important;
    }

    .management-section {
      margin-top: 30px;
      padding-top: 30px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .add-member-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
      margin-bottom: 30px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
    }

    .loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .status-indicator {
      padding: 20px;
      margin: 10px 0;
      border-radius: 10px;
      border-left: 4px solid;
    }

    .status-online {
      background: rgba(40, 167, 69, 0.1);
      border-color: #28a745;
      color: rgba(255, 255, 255, 0.9);
    }

    .status-offline {
      background: rgba(220, 53, 69, 0.1);
      border-color: #dc3545;
      color: rgba(255, 255, 255, 0.9);
    }

    .debug-section {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    .connection-test {
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .glass-card {
        padding: 20px;
        margin: 10px 0;
      }
      
      .filters-section {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        gap: 20px;
      }
      
      h1 {
        font-size: 2rem;
      }

      .data-table {
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginSection" class="login-section">
      <div class="glass-card">
        <h1>WE Trust Admin</h1>
        
        <!-- Connection Status -->
        <div id="connectionStatus" class="status-indicator status-offline">
          <strong>🔴 Backend Status:</strong> <span id="statusText">Checking connection...</span>
        </div>

        <!-- Debug Information -->
        <div id="debugInfo" class="debug-section hidden">
          <strong>Debug Info:</strong><br>
          <div id="debugContent">Ready for connection test...</div>
        </div>

        <!-- Connection Test -->
        <div class="connection-test">
          <button class="btn btn-secondary" onclick="testConnection()" style="width: 100%; margin-bottom: 15px;">
            <span id="testBtnText">Test Backend Connection</span>
          </button>
          <label>
            <input type="checkbox" id="showDebug" onchange="toggleDebug()"> Show Debug Information
          </label>
        </div>

        <!-- Login Form -->
        <div class="form-group">
          <label for="adminUser">Username</label>
          <input type="text" id="adminUser" placeholder="Enter admin username" value="admin">
        </div>
        <div class="form-group">
          <label for="adminKey">Password</label>
          <input type="password" id="adminKey" placeholder="Enter admin password" value="admin123">
        </div>
        
        <!-- Multiple Login Options -->
        <button class="btn btn-primary" onclick="login('backend')" style="margin-bottom: 10px;">
          <span id="loginBtnText">Login with Backend</span>
        </button>
        <button class="btn btn-secondary" onclick="login('demo')" style="width: 100%;">
          Demo Mode (No Backend)
        </button>
      </div>
    </div>

    <div id="dashboard" class="hidden">
      <div class="glass-card">
        <div class="header">
          <div>
            <h1>Admin Dashboard</h1>
            <div id="loginMode" class="info" style="padding: 8px 15px; border-radius: 8px; font-size: 14px; display: inline-block;"></div>
          </div>
          <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>

        <h3>Registration Management</h3>
        
        <div class="filters-section">
          <div class="form-group">
            <input type="text" id="searchName" placeholder="Search name/membership" onkeyup="applyFilters()">
          </div>
          <div class="form-group">
            <select id="filterGrade" onchange="applyFilters()">
              <option value="">All Grades</option>
              <option value="Grade A">Grade A</option>
              <option value="Grade B">Grade B</option>
              <option value="Grade C">Grade C</option>
            </select>
          </div>
          <div class="form-group">
            <select id="filterMode" onchange="applyFilters()">
              <option value="">All Modes</option>
              <option value="Direct">Direct</option>
              <option value="Online">Online</option>
            </select>
          </div>
          <div class="form-group">
            <select id="filterFees" onchange="applyFilters()">
              <option value="">Fees Paid?</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="showUpcomingOnly" onchange="applyFilters()">
            <label for="showUpcomingOnly">Upcoming Only</label>
          </div>
          <div class="form-group">
            <label>From Date</label>
            <input type="date" id="filterFrom" onchange="applyFilters()">
          </div>
          <div class="form-group">
            <label>To Date</label>
            <input type="date" id="filterTo" onchange="applyFilters()">
          </div>
        </div>

        <div class="export-buttons">
          <button class="btn btn-secondary" onclick="exportData('filtered', 'csv')">Export Filtered CSV</button>
          <button class="btn btn-secondary" onclick="exportData('filtered', 'excel')">Export Filtered Excel</button>
          <button class="btn btn-secondary" onclick="exportData('all', 'csv')">Export All CSV</button>
          <button class="btn btn-secondary" onclick="exportData('all', 'excel')">Export All Excel</button>
          <button class="btn btn-secondary" onclick="exportData('logs', 'csv')">Export Logs CSV</button>
          <button class="btn btn-secondary" onclick="exportData('logs', 'excel')">Export Logs Excel</button>
        </div>

        <div id="dataTable" class="data-table">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Membership</th>
                <th>Grade</th>
                <th>Mode</th>
                <th>Fees</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tableBody">
              <tr>
                <td colspan="8" style="text-align: center; padding: 40px;">
                  <div id="loadingText">Loading data...</div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="management-section">
          <button class="btn btn-secondary" onclick="toggleSection('membersSection')">Manage Members</button>
          <button class="btn btn-secondary" onclick="toggleSection('deletedMembersSection')">Show Deleted Members</button>

          <div id="membersSection" class="hidden">
            <h3>Members Management</h3>
            <div class="add-member-form">
              <div class="form-group">
                <label for="newMemberNo">Membership Number</label>
                <input type="text" id="newMemberNo" placeholder="Enter membership number">
              </div>
              <div class="form-group">
                <label for="newMemberName">Member Name</label>
                <input type="text" id="newMemberName" placeholder="Enter member name">
              </div>
              <div class="form-group">
                <label for="newMemberStatus">Status</label>
                <select id="newMemberStatus">
                  <option value="Active">Active</option>
                  <option value="Inactive">Inactive</option>
                </select>
              </div>
              <button class="btn btn-success" onclick="addMember()">Add Member</button>
            </div>
            <div id="membersTable" class="data-table"></div>
          </div>

          <div id="deletedMembersSection" class="hidden">
            <h3>Deleted Members (Recycle Bin)</h3>
            <div id="deletedMembersTable" class="data-table"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // Configuration
    const CONFIG = {
      WEB_APP_URL: "https://script.google.com/macros/s/AKfycbwHmRJpx5Lum07lT--PyHNMbwQdpUIsZFGIrwSSvUWpetSbzIzVg4-W75jVJqb_dr5flg/exec",
      DEMO_CREDENTIALS: { username: "admin", password: "admin123" },
      SESSION_TIMEOUT: 5 * 60 * 1000, // 5 minutes
      WARNING_TIMEOUT: 4 * 60 * 1000  // 4 minutes
    };

    // Global State
    let state = {
      adminUser: "",
      adminKey: "",
      allData: [],
      filteredData: [],
      sessionTimer: null,
      warningTimer: null,
      isLoggedIn: false,
      loginMode: 'offline',
      backendStatus: 'unknown'
    };

    // Demo Data
    const DEMO_DATA = [
      { id: 1, name: "John Doe", membership: "M001", grade: "Grade A", mode: "Online", fees: "Paid", date: "2024-01-15" },
      { id: 2, name: "Jane Smith", membership: "M002", grade: "Grade B", mode: "Direct", fees: "Pending", date: "2024-01-16" },
      { id: 3, name: "Bob Johnson", membership: "M003", grade: "Grade A", mode: "Online", fees: "Paid", date: "2024-01-17" },
      { id: 4, name: "Alice Brown", membership: "M004", grade: "Grade C", mode: "Direct", fees: "Paid", date: "2024-01-18" }
    ];

    const DEMO_MEMBERS = [
      { memberNo: "M001", name: "John Doe", status: "Active" },
      { memberNo: "M002", name: "Jane Smith", status: "Active" },
      { memberNo: "M003", name: "Bob Johnson", status: "Inactive" }
    ];

    // Utility Functions
    function showToast(msg, type = "success") {
      const toast = document.getElementById("toast");
      toast.className = "toast " + type;
      toast.textContent = msg;
      toast.style.display = "block";
      setTimeout(() => toast.style.display = "none", 4000);
    }

    function debugLog(message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      const debugContent = document.getElementById("debugContent");
      const logEntry = `[${timestamp}] ${message}${data ? ': ' + JSON.stringify(data, null, 2) : ''}`;
      
      console.log(logEntry);
      
      if (debugContent) {
        debugContent.innerHTML += logEntry + '<br>';
        debugContent.scrollTop = debugContent.scrollHeight;
      }
    }

    function toggleDebug() {
      const debugInfo = document.getElementById("debugInfo");
      const showDebug = document.getElementById("showDebug").checked;
      
      if (showDebug) {
        debugInfo.classList.remove("hidden");
        debugLog("Debug mode enabled");
      } else {
        debugInfo.classList.add("hidden");
      }
    }

    function updateConnectionStatus(isOnline, message) {
      const statusDiv = document.getElementById("connectionStatus");
      const statusText = document.getElementById("statusText");
      
      state.backendStatus = isOnline ? 'online' : 'offline';
      
      statusDiv.className = `status-indicator ${isOnline ? 'status-online' : 'status-offline'}`;
      statusText.textContent = message;
      
      debugLog(`Connection status: ${isOnline ? 'ONLINE' : 'OFFLINE'}`, { message });
    }

    // Backend Communication
    async function makeRequest(url, options = {}) {
      const defaultOptions = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Cache-Control': 'no-cache'
        },
        timeout: 10000
      };

      const config = { ...defaultOptions, ...options };
      
      debugLog(`Making ${config.method} request to backend`, { url, options: config });

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), config.timeout);
        
        const response = await fetch(url, {
          ...config,
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        
        debugLog(`Response received`, { 
          status: response.status, 
          statusText: response.statusText,
          ok: response.ok 
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        // Try to parse as JSON first, fallback to text
        let responseData;
        const contentType = response.headers.get('content-type');
        
        if (contentType && contentType.includes('application/json')) {
          responseData = await response.json();
        } else {
          responseData = await response.text();
        }
        
        debugLog(`Response data parsed`, { data: responseData });
        
        return { success: true, data: responseData, response };
        
      } catch (error) {
        debugLog(`Request failed`, { error: error.message });
        
        if (error.name === 'AbortError') {
          throw new Error('Request timeout - please check your connection');
        }
        
        throw error;
      }
    }

    // Connection Testing
    async function testConnection() {
      const testBtn = document.querySelector('button[onclick="testConnection()"]');
      const testBtnText = document.getElementById("testBtnText");
      
      testBtn.disabled = true;
      testBtnText.textContent = "Testing...";
      
      debugLog("Starting connection test");
      
      try {
        // Test basic connectivity
        const testUrl = `${CONFIG.WEB_APP_URL}?action=ping&timestamp=${Date.now()}`;
        const result = await makeRequest(testUrl);
        
        updateConnectionStatus(true, "✅ Backend connected successfully");
        showToast("✅ Backend connection successful", "success");
        
        return true;
        
      } catch (error) {
        updateConnectionStatus(false, `❌ Connection failed: ${error.message}`);
        showToast(`❌ Backend connection failed: ${error.message}`, "error");
        
        return false;
        
      } finally {
        testBtn.disabled = false;
        testBtnText.textContent = "Test Backend Connection";
      }
    }

    // Authentication
    async function login(mode = 'backend') {
      const loginBtn = document.querySelector(`button[onclick="login('${mode}')"]`);
      const btnText = mode === 'backend' ? document.getElementById("loginBtnText") : loginBtn.querySelector('span') || loginBtn;
      const originalText = btnText.textContent;
      
      loginBtn.disabled = true;
      btnText.textContent = "Logging in...";
      
      try {
        state.adminUser = document.getElementById("adminUser").value.trim();
        state.adminKey = document.getElementById("adminKey").value.trim();
        
        if (!state.adminUser || !state.adminKey) {
          showToast("⚠️ Please enter both username and password", "warning");
          return;
        }
        
        debugLog(`Login attempt`, { mode, username: state.adminUser });
        
        if (mode === 'demo') {
          // Demo mode - no backend required
          if (state.adminUser === CONFIG.DEMO_CREDENTIALS.username && 
              state.adminKey === CONFIG.DEMO_CREDENTIALS.password) {
            
            debugLog("Demo login successful");
            state.loginMode = 'demo';
            state.isLoggedIn = true;
            
            showSuccessfulLogin("🚀 Demo Mode - No backend required");
            return;
          } else {
            throw new Error("Demo credentials: admin / admin123");
          }
        }
        
        // Backend mode
        const loginUrl = `${CONFIG.WEB_APP_URL}?action=login&username=${encodeURIComponent(state.adminUser)}&adminKey=${encodeURIComponent(state.adminKey)}`;
        const result = await makeRequest(loginUrl);
        
        // Check various success indicators
        const data = result.data;
        const isSuccess = 
          (typeof data === 'string' && (data.includes('✅') || data.toLowerCase().includes('success'))) ||
          (typeof data === 'object' && (data.success === true || data.status === 'success')) ||
          result.response.ok;
        
        if (isSuccess) {
          debugLog("Backend login successful");
          state.loginMode = 'backend';
          state.isLoggedIn = true;
          
          const message = typeof data === 'string' ? data : (data.message || "✅ Login successful");
          showSuccessfulLogin(message);
        } else {
          const errorMsg = typeof data === 'string' ? data : (data.error || data.message || "Invalid credentials");
          throw new Error(errorMsg);
        }
        
      } catch (error) {
        debugLog(`Login failed`, { error: error.message });
        showToast(`❌ Login failed: ${error.message}`, "error");
        
      } finally {
        loginBtn.disabled = false;
        btnText.textContent = originalText;
      }
    }

    function showSuccessfulLogin(message) {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("dashboard").classList.remove("hidden");
      
      // Update login mode indicator
      const modeIndicator = document.getElementById("loginMode");
      modeIndicator.textContent = `Mode: ${state.loginMode.toUpperCase()}`;
      modeIndicator.className = state.loginMode === 'demo' ? 'warning' : 'success';
      
      showToast(message, "success");
      startSessionTimer();
      loadRegistrations();
    }

    async function logout() {
      debugLog("Logging out");
